{% extends "layouts/base.html" %}
{% load static %}

{% block header %}Chart{% endblock %}

{% block content %}
<div id="chart-container">
    <div id="chart"></div>
</div>
<script src="{% static 'js/plotly-2.36.2.min.js' %}"></script>
<script>
    var traces = [];
    const MAX_POINTS = 500;
    const POLLING_INTERVAL = 1000;

    // Initial data fetch
    fetch('/api/sensor-data/chart/')
        .then(response => response.json())
        .then(response => {
            var sensorGroups = {};

            response.data.forEach(item => {
                if (!sensorGroups[item.sensor]) {
                    sensorGroups[item.sensor] = { x: [], y: [] };
                }
                sensorGroups[item.sensor].x.push(item.timestamp);
                sensorGroups[item.sensor].y.push(item.t);
            });

            for (var sensor in sensorGroups) {
                traces.push({
                    x: sensorGroups[sensor].x,
                    y: sensorGroups[sensor].y,
                    mode: 'lines',
                    name: sensor
                });
            }

            const layout = {
                yaxis: {
                    range: [0, 100]
                },
                legend: {
                    orientation: 'h',
                    yanchor: 'bottom',
                    y: -0.2,
                    xanchor: 'center',
                    x: 0.5
                },
                margin: {
                    b: 100  // Aumentar margen inferior para la leyenda
                }
            };

            Plotly.newPlot('chart', traces, layout);
        });

    function updateChart(data) {
        var update = { x: [], y: [] };
        var sensorGroups = {};

        data.forEach(item => {
            if (!sensorGroups[item.sensor]) {
                sensorGroups[item.sensor] = { x: [], y: [] };
            }
            sensorGroups[item.sensor].x.push(item.timestamp);
            sensorGroups[item.sensor].y.push(item.t);
        });

        traces.forEach((trace, i) => {
            const sensor = trace.name;
            if (sensorGroups[sensor]) {
                update.x.push(sensorGroups[sensor].x);
                update.y.push(sensorGroups[sensor].y);

                if (trace.x.length > MAX_POINTS) {
                    const excess = trace.x.length - MAX_POINTS;
                    trace.x = trace.x.slice(excess);
                    trace.y = trace.y.slice(excess);
                }
            }
        });

        if (update.x.length > 0) {
            Plotly.extendTraces('chart', update, Array.from(Array(update.x.length).keys()));
        }
    }

    // Regular polling with fetch
    setInterval(() => {
        fetch('/api/sensor-data/chart/?recent=true')
            .then(response => response.json())
            .then(response => updateChart(response.data))
            .catch(error => console.error('Error fetching data:', error));
    }, POLLING_INTERVAL);
</script>
{% endblock %}