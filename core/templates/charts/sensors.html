{% extends "layouts/base.html" %}
{% load static %}

{% block subtitle %}SENSORES{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/charts.css' %}">
{% endblock %}

{% block navbar %}
    {% include 'partials/navbar.html' with is_charts_page=True %}
{% endblock %}

{% block content %}
    <div id="toggle-buttons-container">
        <div id="toggle-buttons" class="button-group">
            <div id="toggle-buttons-timeframe" class="button-cluster">
                <a class="button {% if selected_timeframe == '5S' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=5S"><small>5"</small></a>
                <a class="button {% if selected_timeframe == '1T' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=1T">1'</a>
                <a class="button {% if selected_timeframe == '30T' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=30T">30'</a>
                <a class="button {% if selected_timeframe == '1H' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=1H">1h</a>
                <a class="button {% if selected_timeframe == '4H' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=4H">4h</a>
                <a class="button {% if selected_timeframe == '1D' %}active{% endif %}" href="{% url 'sensors' %}?timeframe=1D">1d</a>
            </div>
        </div>
    </div>
    <div class="sensors-wrapper">
        {% for room_name, sensors in sensors_by_room.items %}
            <div class="room-title-wrapper">
                <h2 class="room-title">Sala {{ room_name }}</h2>
            </div>
            <div class="chart-grid sensors-grid">
                {% for sensor_data in sensors %}
                    <div class="chart-container sensor-container"
                         title="{{ room_name }} - {{ sensor_data.sensor_name }}"
                         data-sensor="{{ sensor_data.sensor_name }}"
                         data-metric="{{ sensor_data.metric }}"
                         data-values='{{ sensor_data.values|safe }}'>
                        <div class="loading">
                            <div class="placeholder-animation"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% empty %}
            <p>No data available.</p>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.1.min.js" charset="utf-8"></script>
    <script>
        $(document).ready(function() {
            $('.chart-container').each(function() {
                var container = $(this);
                var sensor = container.data('sensor');
                var metric = container.data('metric');
                var values = container.data('values');
                
                // Ensure values is treated as an array of tuples
                var processedValues = [];
                for (var i = 0; i < values.length; i++) {
                    processedValues.push([
                        values[i][0].toString(),
                        values[i][1]
                    ]);
                }

                $.ajax({
                    url: '/generate_sensor/',
                    method: 'POST',
                    data: {
                        sensor: sensor,
                        metric: metric,
                        values: JSON.stringify(processedValues)
                    },
                    success: function(data) {
                        container.html(data);
                    },
                    error: function() {
                        container.html('<p>Error loading chart</p>');
                    }
                });
            });
        });
    </script>
{% endblock %}
